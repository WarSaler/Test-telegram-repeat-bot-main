# Автозапуск и автоматический перезапуск бота

Этот документ описывает настройку автоматического запуска и перезапуска Telegram бота.

## Развертывание на Render

**Важно**: Если ваш бот развернут на платформе Render, автозапуск и автоматический перезапуск настраиваются автоматически платформой. Вам не нужно настраивать локальные сервисы на вашем компьютере.

### Автоматические возможности Render:

- **Автозапуск**: Бот автоматически запускается при развертывании
- **Автоматический перезапуск**: При сбоях или ошибках Render автоматически перезапускает сервис
- **Мониторинг**: Платформа отслеживает состояние приложения 24/7
- **Логирование**: Все логи доступны в панели управления Render
- **Масштабирование**: Автоматическое управление ресурсами

### Настройка на Render:

1. **Подключите репозиторий** к Render
2. **Выберите тип сервиса**: Web Service
3. **Команда запуска**: `python bot.py`
4. **Переменные окружения**: Добавьте все необходимые токены и ключи
5. **Автодеплой**: Включите автоматическое развертывание при изменениях в репозитории

## Локальная разработка

Для локальной разработки и тестирования просто запускайте:

```bash
python bot.py
```

**Примечание**: Локальные сервисы автозапуска не нужны, так как бот работает на облачной платформе Render независимо от вашего компьютера.

## Управление сервисом

### Основные команды

```bash
# Запуск сервиса
./manage_service.sh start

# Остановка сервиса
./manage_service.sh stop

# Перезапуск сервиса
./manage_service.sh restart

# Статус сервиса
./manage_service.sh status

# Просмотр логов в реальном времени
./manage_service.sh logs

# Удаление сервиса
sudo ./manage_service.sh uninstall
```

### Ручное управление через systemctl

```bash
# Запуск
sudo systemctl start telegram-bot

# Остановка
sudo systemctl stop telegram-bot

# Перезапуск
sudo systemctl restart telegram-bot

# Статус
systemctl status telegram-bot

# Логи
journalctl -u telegram-bot -f
```

## Особенности настройки

### Автоматический перезапуск

Сервис настроен на автоматический перезапуск при сбоях:
- `Restart=always` - перезапуск при любом завершении
- `RestartSec=10` - задержка 10 секунд перед перезапуском

### Проверка зависимостей

Скрипт `start_bot.sh` выполняет:
- Проверку наличия Python3
- Установку зависимостей из requirements.txt
- Загрузку переменных окружения из .env
- Проверку критически важных переменных
- Корректную остановку предыдущих процессов

### Логирование

Логи сервиса доступны через:
- `journalctl -u telegram-bot` - все логи
- `journalctl -u telegram-bot -f` - логи в реальном времени
- `journalctl -u telegram-bot --since today` - логи за сегодня

### Безопасность

Сервис настроен с ограничениями безопасности:
- `NoNewPrivileges=true` - запрет повышения привилегий
- `PrivateTmp=true` - изолированная временная директория
- `ProtectSystem=strict` - защита системных директорий
- `ProtectHome=true` - защита домашних директорий

## Переменные окружения

Создайте файл `.env` в директории проекта с необходимыми переменными:

```bash
BOT_TOKEN=your_bot_token_here
GOOGLE_SHEETS_CREDENTIALS_JSON=path_to_credentials.json
GOOGLE_SHEETS_ID=your_sheets_id
# Другие переменные...
```

## Устранение неполадок

### Проверка статуса
```bash
./manage_service.sh status
```

### Просмотр логов
```bash
./manage_service.sh logs
```

### Проверка файлов
```bash
# Проверка файла сервиса
sudo systemctl cat telegram-bot

# Проверка конфигурации systemd
sudo systemd-analyze verify telegram-bot.service
```

### Перезагрузка конфигурации
```bash
sudo systemctl daemon-reload
sudo systemctl restart telegram-bot
```

## Автозапуск при загрузке системы

После установки сервиса он автоматически включается для запуска при загрузке системы. Для проверки:

```bash
systemctl is-enabled telegram-bot
```

Должно вернуть `enabled`.

## Мониторинг

Для мониторинга работы бота можно использовать:

```bash
# Проверка активности сервиса
systemctl is-active telegram-bot

# Время последнего запуска
systemctl show telegram-bot --property=ActiveEnterTimestamp

# Количество перезапусков
systemctl show telegram-bot --property=NRestarts
```